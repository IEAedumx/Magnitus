<tarea nombre="Registra Actualización de Almacen" version="1.0.0" fechaModificacion="" autor="" modificacionEfectuada="" requisitosInstalacion="">
    <pagina id="1" nombre="Registra Actualización de Almacen">
        <nivel id="bPer" nombre="buscaPeriodo" interactivo="false">
            <componente tipo="cursor" id="bPer" nombre="buscaPeriodo">
                <tabla schema="catalog" nombre="periodo">
                    <campo name="id_unidad_responsable" filtroCampo="id_unidad_responsable" filtroOperador="=" filtroValor="$config.ur$"/>
                    <campo name="estatus" filtroCampo="estatus" filtroOperador="=" filtroValor="true"/>
                    <campo name="id_estatus" filtroCampo="id_estatus" filtroOperador="=" filtroValor="3"/>
                    <campo name="id_periodo"/>
                </tabla>
            </componente>
        </nivel>
        <nivel nombre="barreUsuarios" id="bU" interactivo="false">
            <componente tipo="cursor" nombre="bU" id="bU">
                <tabla schema="entity" nombre="usuario">
                    <campo name="id_unidad_responsable" filtroCampo="id_unidad_responsable" filtroOperador="=" filtroValor="%bPer.bPer.id_unidad_responsable%"/>
                    <campo name="nombre_usuario" filtroCampo="nombre_usuario" filtroOperador="=" filtroValor="$protocolarios.user$"/>
                    <campo name="id_usuario"/>
                </tabla>
            </componente>
        </nivel>
        <nivel nombre="Datos Generales del Movimiento" id="dG" mostrarNivelAnterior="false" mostrarProximoNivel="false">
            <componente tipo="formulario" nombre="Datos Generales del Movimiento" id="dG">
                <tabla schema="operation" nombre="registro_act_almacen">
                    <campo name="ur" text="UR" calc="%bPer.bPer.id_unidad_responsable%" llaveForanea="false" visible="false"/>
                    <campo name="id_periodo" text="Periodo" calc="%bPer.bPer.id_periodo%" llaveForanea="false" visible="false"/>
                    <campo name="id_registro_act_almacen" text="" autogenerado="true" generacion="@prox()+1" visible="false"/>
                    <campo name="id_tipo_movimientos" text="Tipo de Movimiento *" descripcionForanea="descripcion" columnas="3"  validacion="%id_tipo_movimientos%==null" validacionMensaje="Seleccione Tipo de Movimiento"/>
                    <campo name="transaccion" text="Transacción *" descripcionForanea="transaccion" columnas="3" />
                    <campo name="fecha_elaboracion" text="Fecha" calc="@fechaSistema('YYYY/MM/dd HH:mm:ss')" columnas="3" />
                    <campo name="folio_registro_act_almacen" text="Folio" visible="false" calc="
                        @concatenar('ALM-'+
                        @subCadena(@ifThenElse(@consultaDirec('
                        SELECT (folio_registro_act_almacen) AS resultado 
                        FROM operation.registro_act_almacen 
                        WHERE ur='+%bPer.bPer.id_unidad_responsable%+' AND id_periodo='+%bPer.bPer.id_periodo%+' 
                        ORDER BY folio_registro_act_almacen DESC limit 1','resultado','string','MAGNITUS')==null,'000001',
                        @consultaDirec('
                        SELECT to_char((((substring(folio_registro_act_almacen FROM char_length(folio_registro_act_almacen)-4)::int)+1)),\\''+'00000'+'\\') as resultado 
                        FROM operation.registro_act_almacen 
                        WHERE ur='+%bPer.bPer.id_unidad_responsable%+' AND id_periodo='+%bPer.bPer.id_periodo%+' ORDER BY folio_registro_act_almacen DESC limit 1','resultado','int','MAGNITUS')),1,6))"/>
                </tabla>
                <estilos>
                    <boton nombre="grabar" visible="true" texto="Continuar" columnas="2" margen-izquierdo="4"/>
                </estilos>
                <acciones>
                    <accion nombre="grabar" hacer="saltar siguiente nivel"/>
                </acciones>
            </componente>
        </nivel>
        <nivel nombre="Registra Entradas de Almacén" id="rEA" mostrarNivelAnterior="false" mostrarProximoNivel="true" ejecutar="%dG.dG.id_tipo_movimientos%==1">
            <componente tipo="maestroDetalle" nombre="Registra Entradas de Almacén" id="rEA">
                <encabezado accionDefault="editar">
                    <tabla schema="operation" nombre="registro_act_almacen" id="rEA" tituloDetalle="Registra Entradas de Almacén">
                        <campo name="ur" text="UR" calc="%dG.dG.ur%" llaveForanea="false" visible="false"/>
                        <campo name="id_periodo" text="Periodo" calc="%dG.dG.id_periodo%" llaveForanea="false" visible="false"/>
                        <campo name="id_registro_act_almacen" text="" calc="%dG.dG.id_registro_act_almacen%" llaveForanea="false" visible="false"/>
                        <campo name="folio_registro_act_almacen" text="Folio" habilitado="false" columnas="3" />
                        <campo name="id_almacenes" text="Clave Almacen *" descripcionForanea="nombre" validacion="%id_almacenes%==null" validacionMensaje="Seleccione Almacen de Entrada" columnas="3"/>
                        <campo name="fecha_entrada" text="Fecha *" calc="@fechaSistema()" validacion="%fecha_entrada%==null OR @after(%fecha_entrada%,@fechaSistema())" validacionMensaje="No puede ingresar una fecha vacia o posterior a la fecha de registro " columnas="3"/>
                        <campo name="nombre" text="Almacen" columnas="3"  referenciaForanea="id_almacenes" celdaForanea="nombre" autocompletar="true"/>
                        <campo name="id_tipo_movimientos" text="Tipo de Movimiento" descripcionForanea="descripcion" habilitado="false" columnas="3" />
                        <campo name="adjunto_ex" text="Adjuntar excel" type="file" update="false" local="true" fileType="normal" url="$config.repository_upload_file$" nombreDocumento="'Adjunto Excel'" grupo="%dG.dG.id_registro_act_almacen%" expediente="Actualizaciones de Almacén" columnas="3" />
                        <campo name="transaccion" text="Transacciona" visible="false"/>
                        <campo name="transaccion_local" text="Transaccion" local="true" type="string" calc="'Inventario Inicial'" habilitado="false" columnas="3" />
                        <campo name="adjunto_doc" text="Adjuntar Documentación" type="file" update="false" local="true" fileType="normal" url="$config.repository_upload_file$" nombreDocumento="'Adjunta Documentación'" grupo="%dG.dG.id_registro_act_almacen%" expediente="Actualizaciones de Almacén" columnas="3" />
                        <campo name="concepto" text="Concepto *" width="720" height="150" columnas="6" margen-izquierdo="2" margen-derecho="2" validacion="%concepto%==null" validacionMensaje="Capture Concepto"/>
                        <campo name="usuario_alta" text="usuario_alta" calc="%bU.bU.id_usuario%" llaveForanea="false" visible="false"/>
                    </tabla>
                    <estilos>
                        <boton nombre="grabar" visible="true" texto="Continuar" columnas="2" margen-izquierdo="4"/>
                    </estilos>
                </encabezado>
                <!--Entrada -->
                <detalles tituloDetalle="Agregar Bloque">
                    <tabla schema="operation" nombre="registro_act_almacen_det" id="rEAd">
                        <campo name="ur"  llaveForanea="false" columna-visible="false" visible="false"/>
                        <campo name="id_periodo"  llaveForanea="false" columna-visible="false" visible="false"/>
                        <campo name="id_registro_act_almacen"  llaveForanea="false" columna-visible="false" visible="false"/>
                        <campo name="id_registro_act_almacen_det"  llaveForanea="false" autogenerado="true" generacion="@prox()+1" columna-visible="false" visible="false"/>
                        <campo name="id_centro_registro" text="" llaveForanea="false" calc="2" visible="false" columna-visible="false"/>
                        <campo name="fecha_elaboracion" text="" calc="@fechaSistema('YYYY/MM/dd HH:mm:ss')" columna-visible="false" visible="false"/>
                        <campo name="articulo" text="Clave artículo *" width="300" descripcionForanea="descripcion_articulo" descripcionForaneaTabla="descripcion" validacion="%articulo%==null" validacionMensaje="Seleccione Artículo" columnas="3"  />
                        <campo name="id_cat_cog" text="" llaveForanea="false" calc="4" visible="false" columna-visible="false"/>
                        <campo name="id_cog" text="COG" width="300" habilitado="false"
                        calcCliente="@consultaDirec('SELECT (id_cat_clasificacion_objeto_gasto) AS result FROM catalog.articulos WHERE ur='+%dG.dG.ur%+' AND '+'periodo='+'\\''+%dG.dG.id_periodo%+'\\''+' AND '+' clave_articulo='+'\\''+%articulo%+'\\'','result','string','MAGNITUS')"
                        validacion="%id_cog%==null" validacionMensaje="Favor de agregar el COG" columnas="3" />
                        <campo name="des_articulo" text="Descripción del artículo" width="200" columna-visible="false" referenciaForanea="articulo" celdaForanea="descripcion_articulo" autocompletar="true" columnas="3"/>
                        <campo name="clave_cuentas_contables" text="Clave Cuenta C.A" width="300" descripcionForanea="clave_cuenta,descripcion" descripcionForaneaTabla="clave_cuenta,descripcion" validacion="%clave_cuentas_contables%==null" validacionMensaje="Favor de seleccionar clave cuenta C.A" columnas="3" />
                        <campo name="des_cuenta_contable" text="Descripcion de Cuenta C.A" referenciaForanea="clave_cuentas_contables" celdaForanea="descripcion" autocompletar="true" columna-visible="false" width="300" validacion="%des_cuenta_contable%==null" validacionMensaje="Favor de agregar descripcion de cuenta C.A" columnas="3"  />
                        <campo name="id_unidad_medida" text="Clave Unidad de Medida" habilitado="false" referenciaForanea="articulo" celdaForanea="unidad_medida" autocompletar="true" columnas="3"  />
                        <campo name="des_unidad_medida" text="Descripción Unidad de Medida" width="230" columna-visible="false" referenciaForanea="id_unidad_medida" celdaForanea="descripcion" autocompletar="true" columnas="3"  />
                        <campo name="cantidad_entrada" text="Cantidad Entrada *" validacion="%cantidad_entrada%==null" validacionMensaje="Indique Cantidad de Artículos" columnas="3" />
                        <campo name="centro_registro" text="Clave Centro de Registro" validacion="%centro_registro%==null" validacionMensaje="Favor de agregar clave de centro registro" width="220" columnas="3"  />
                        <campo name="des_centro_registro" text="Descripción Centro de Registro" columna-visible="false" width="230" referenciaForanea="centro_registro" celdaForanea="descripcion" autocompletar="true" columnas="3" />
                        <campo name="id_cat_fondo" text="" llaveForanea="false" calc="3" visible="false" columna-visible="false"/>
                        <campo name="fondo_contable" text="Clave de Fondo" width="120"  columnas="3"  />
                        <campo name="des_fondo_contable" text="Descripción de Fondo" width="200" referenciaForanea="fondo_contable"  celdaForanea="descripcion" autocompletar="true" columnas="3" />
                        <campo name="costo_unitario" text="Costo Unitario *" width="120" validacion="%costo_unitario%==null" validacionMensaje="Capture Costo Unitario" columnas="3" />
                        <campo name="total" text="Total *" habilitado="false" calcCliente="@ifThenElse(%cantidad_entrada%==null,0,%cantidad_entrada%)*@ifThenElse(%costo_unitario%==null,0,%costo_unitario%)" columnas="3" />
                        <campo name="observaciones" text="Observaciones" width="720" height="150" validacion="%observaciones%==null" validacionMensaje="Favor de agregar observaciones" columnas="6" />    
                        <campo name="usuario_alta" text="usuario_alta" calc="%bU.bU.id_usuario%" llaveForanea="false" visible="false"/>
                    </tabla>
                </detalles>
            </componente>
        </nivel>
        <nivel nombre="b_acumular" id="b_acumular" interactivo="false" ejecutar="%dG.dG.id_tipo_movimientos%==1">
            <componente tipo="cursor" nombre="b_acumular" id="b_acumular">
                <tabla schema="operation" nombre="registro_act_almacen_det">
                    <campo name="ur" filtroCampo="ur" filtroOperador="=" filtroValor="%rEA.rEA.ur%"/>
                    <campo name="id_periodo" filtroCampo="id_periodo" filtroOperador="=" filtroValor="%rEA.rEA.id_periodo%"/>
                    <campo name="id_registro_act_almacen" filtroCampo="id_registro_act_almacen" filtroOperador="=" filtroValor="%rEA.rEA.id_registro_act_almacen%"/>
                    <campo name="id_registro_act_almacen_det"/>
                    <campo name="total"/>
                    <campo name="articulo"/>
                    <campo name="acumulado" local="true" type="double" calc="$sumatoria.total$"/>
                </tabla>
            </componente>
        </nivel>
        <nivel nombre="acumular" id="acumular" interactivo="false" ejecutar="%dG.dG.id_tipo_movimientos%==1">
            <componente tipo="cursor" nombre="acumular" id="acumular">
                <tabla schema="operation" nombre="registro_act_almacen" id="rEA">
                    <campo name="ur" filtroCampo="ur" filtroOperador="=" filtroValor="%rEA.rEA.ur%"/>
                    <campo name="id_periodo" filtroCampo="id_periodo" filtroOperador="=" filtroValor="%rEA.rEA.id_periodo%"/>
                    <campo name="id_registro_act_almacen" filtroCampo="id_registro_act_almacen" filtroOperador="=" filtroValor="%rEA.rEA.id_registro_act_almacen%"/>
                    <campo name="total" calc="%b_acumular.b_acumular.acumulado%"/>
                </tabla>
            </componente>
        </nivel>
        <nivel nombre="crearNuevaInstancia" id="cIEntrada" interactivo="false" ejecutar="%dG.dG.id_tipo_movimientos%==1">
            <componente tipo="solicitud" nombre="EnvioParametrosDynamo" id="cIEntrada" >
                <parametros url="$config.request$" metodo="POST" accion="crearNuevaInstancia" tipo="json">
                    <parametro name="enterprise" calc="'MAGNITUS'"/>
                    <parametro name="process" calc="'d02bebb1-7f66-44d5-9d9b-f60edecaf402'"/>
                    <parametro name="user" calc="$protocolarios.user$"/>
                    <parametro name="out_ur" calc="%rEA.rEA.ur%" mostrarEsc="true"/>
                    <parametro name="out_id_periodo" calc="%rEA.rEA.id_periodo%" mostrarEsc="true"/>
                    <parametro name="out_id_tipo_movimientos" calc="%rEA.rEA.id_tipo_movimientos%" mostrarEsc="true"/>
                    <parametro name="out_id_registro_act_almacen" calc="%rEA.rEA.id_registro_act_almacen%" mostrarEsc="true"/>
                    <parametro name="out_tarjeta_almacen" calc="'1'" mostrarEsc="true"/>
                </parametros>
            </componente>
        </nivel>
        <nivel nombre="Entrada de Almacén" id="entrada" mostrarNivelAnterior="false" mostrarProximoNivel="false" ejecutar="%dG.dG.id_tipo_movimientos%==1">
            <componente tipo="reporte" nombre="Entrada de Almacén" id="entrada">
                <reporte nombre="repor_entAlmacen_jsus" update="true" nombreDocumento="'Entrada de Almacén'" expediente="Actualizaciones de Almacén"  grupo="%dG.dG.id_registro_act_almacen%" url="$config.repository_upload_file$">
                     <campo name="ur"  type="long" calc="%rEA.rEA.ur%"/>
                     <campo name="periodo" type="long" calc="%rEA.rEA.id_periodo%"/>
                     <campo name="id_registro_act_almacen" type="long" calc="%rEA.rEA.id_registro_act_almacen%"/>
                     <campo name="usuario" type="string" calc="$protocolarios.user$"/>
                </reporte>
            </componente>
        </nivel>
            
        <nivel nombre="Registra Salida de Almacén" id="rSA" mostrarNivelAnterior="false" mostrarProximoNivel="true" ejecutar="%dG.dG.id_tipo_movimientos%==2">
            <componente tipo="maestroDetalle" nombre="Registra Salida de Almacén" id="rSA">
                <encabezado accionDefault="editar">
                    <tabla schema="operation" nombre="registro_act_almacen" id="rEA" tituloDetalle="Registra Salida de Almacén">
                        <campo name="ur" text="UR" calc="%dG.dG.ur%" llaveForanea="false" visible="false"/>
                        <campo name="id_periodo" text="Periodo" calc="%dG.dG.id_periodo%" llaveForanea="false" visible="false"/>
                        <campo name="id_registro_act_almacen" text="" calc="%dG.dG.id_registro_act_almacen%" llaveForanea="false" visible="false"/>
                        <campo name="folio_registro_act_almacen" text="Folio" calc="@concatenar('ALM-'+@subCadena(@ifThenElse(
                        @consultaDirec('
                        SELECT (folio_registro_act_almacen) AS resultado
                        FROM operation.registro_act_almacen
                        WHERE ur='+%dG.dG.ur%+' AND id_periodo='+%dG.dG.id_periodo%+' ORDER BY folio_registro_act_almacen DESC limit 1','resultado','string','MAGNITUS')==null
                        ,
                        '000001'
                        ,
                        @consultaDirec('
                        SELECT to_char((((substring(folio_registro_act_almacen from char_length(folio_registro_act_almacen)-4)::int)+1)),\\''+'00000'+'\\') as resultado
                        FROM operation.registro_act_almacen
                        WHERE ur='+%dG.dG.ur%+' AND id_periodo='+%dG.dG.id_periodo%+' ORDER BY folio_registro_act_almacen DESC limit 1','resultado','int','MAGNITUS')
                        ),1,6))" columnas="3" />
                        <campo name="id_almacenes" text="Clave Almacen *" descripcionForanea="nombre" validacion="%id_almacenes%==null" validacionMensaje="Seleccione Almacen de Entrada" columnas="3" />
                        <campo name="fecha_entrada" text="Fecha *" calc="@fechaSistema()" validacion="%fecha_entrada%==null OR @after(%fecha_entrada%,@fechaSistema())" validacionMensaje="No puede ingresar una fecha vacia o posterior a la fecha de registro " columnas="3" />
                        <campo name="nombre" text="Almacen" columnas="3"  referenciaForanea="id_almacenes" celdaForanea="nombre" autocompletar="true"/>
                        <campo name="id_tipo_movimientos" text="Tipo de Movimiento" descripcionForanea="descripcion" habilitado="false" columnas="3" />
                        <campo name="adjunto_ex" text="Adjuntar excel" type="file" update="false" local="true" fileType="normal" url="$config.repository_upload_file$" nombreDocumento="'Adjunto Excel'" grupo="%dG.gCA.id_registro_act_almacen%" expediente="Actualizaciones de Almacén" columnas="3" />
                        <campo name="transaccion" text="" visible="false"/>
                        <campo name="transaccion_local" text="Transaccion" local="true" type="string" calc="'Inventario Inicial'" habilitado="false" columnas="3" />
                        <campo name="adjunto_doc" text="Adjuntar Documentación" type="file" update="false" local="true" fileType="normal" url="$config.repository_upload_file$" nombreDocumento="'Adjunta Documentación'" grupo="%dG.gCA.id_registro_act_almacen%" expediente="Actualizaciones de Almacén" columnas="3" />
                        <campo name="concepto" text="Concepto *" width="720" height="150" columnas="6" margen-izquierdo="2" margen-derecho="2" validacion="%concepto%==null" validacionMensaje="Capture Concepto"/>
                        <campo name="usuario_alta" text="usuario_alta" calc="%bU.bU.id_usuario%" llaveForanea="false" visible="false"/>
                    </tabla>
                    <estilos>
                        <boton nombre="grabar" visible="true" texto="Continuar" columnas="2" margen-izquierdo="4"/>
                    </estilos>
                </encabezado>
            <!--salida -->    
                <detalles tituloDetalle="Agregar Renglón">
                    <tabla schema="operation" nombre="registro_act_almacen_det" id="rEAd">
                        <campo name="ur"  llaveForanea="false" columna-visible="false" visible="false"/>
                        <campo name="id_periodo"  llaveForanea="false" columna-visible="false" visible="false"/>
                        <campo name="id_registro_act_almacen"  llaveForanea="false" columna-visible="false" visible="false"/>
                        <campo name="id_registro_act_almacen_det"  llaveForanea="false" autogenerado="true" generacion="@prox()+1" columna-visible="false" visible="false"/>
                        <campo name="id_centro_registro" text="" llaveForanea="false" calc="2" visible="false" columna-visible="false"/>
                        <campo name="fecha_elaboracion" text="" calc="@fechaSistema('YYYY/MM/dd HH:mm:ss')" columna-visible="false" visible="false"/>
                        <campo name="articulo" text="Clave artículo *" width="300" descripcionForanea="descripcion_articulo" descripcionForaneaTabla="descripcion" validacion="%articulo%==null" validacionMensaje="Seleccione Artículo" columnas="3"  />
                        <campo name="id_unidad_medida" text="Unidad de Medida" habilitado="false" referenciaForanea="articulo" celdaForanea="unidad_medida" autocompletar="true" columnas="3" />
                        <campo name="existencia" text="Existencia" habilitado="false" calcCliente="@ifThenElse(@consultaDirec('
                        SELECT (cantidad_entrada) AS resultado
                        FROM operation.tarjeta_almacen
                        WHERE ur='+%dG.dG.ur%+' AND id_periodo='+%dG.dG.id_periodo%+' 
                        AND articulo='+'\\''+@ifThenElse(%articulo%==null,'0',%articulo%)+'\\' ORDER BY id_tarjeta_almacen DESC limit 1','resultado','int','MAGNITUS')==null,0,@consultaDirec('
                        SELECT (cantidad_entrada) AS resultado
                        FROM operation.tarjeta_almacen
                        WHERE ur='+%dG.dG.ur%+' AND id_periodo='+%dG.dG.id_periodo%+' 
                        AND articulo='+'\\''+@ifThenElse(%articulo%==null,'0',%articulo%)+'\\' ORDER BY id_tarjeta_almacen DESC limit 1','resultado','int','MAGNITUS'))
                        -
                        @ifThenElse(%cantidad_salida%==null,0,%cantidad_salida%)" columnas="3" />
                        <campo name="cantidad_entrada" text="Existencia" habilitado="false" calcCliente="@ifThenElse(@consultaDirec('
                        SELECT (cantidad_entrada) AS resultado
                        FROM operation.tarjeta_almacen
                        WHERE ur='+%dG.dG.ur%+' AND id_periodo='+%dG.dG.id_periodo%+' 
                        AND articulo='+'\\''+@ifThenElse(%articulo%==null,'0',%articulo%)+'\\' ORDER BY id_tarjeta_almacen DESC limit 1','resultado','int','MAGNITUS')==null,0,@consultaDirec('
                        SELECT (cantidad_entrada) AS resultado
                        FROM operation.tarjeta_almacen
                        WHERE ur='+%dG.dG.ur%+' AND id_periodo='+%dG.dG.id_periodo%+' 
                        AND articulo='+'\\''+@ifThenElse(%articulo%==null,'0',%articulo%)+'\\' ORDER BY id_tarjeta_almacen DESC limit 1','resultado','int','MAGNITUS'))
                        -
                        @ifThenElse(%cantidad_salida%==null,0,%cantidad_salida%)" visible="false"/>
                        <campo name="costo_unitario" text="Costo Unitario *" width="120" calcCliente="@consultaDirec('
                        SELECT (costo_unitario) AS resultado
                        FROM operation.tarjeta_almacen
                        WHERE ur='+%dG.dG.ur%+' AND id_periodo='+%dG.dG.id_periodo%+' 
                        AND articulo='+'\\''+@ifThenElse(%articulo%==null,'0',%articulo%)+'\\' ORDER BY id_tarjeta_almacen DESC limit 1','resultado','int','MAGNITUS')" validacion="%costo_unitario%==null" validacionMensaje="Capture Costo Unitario" columnas="3" />
                        <campo name="id_cat_fondo" text="" llaveForanea="false" calc="3" visible="false" columna-visible="false"/>
                        <campo name="fondo_contable" text="Clave de Fondo" width="120" calcCliente="@consultaDirec('
                        SELECT (fondo_contable) AS resultado
                        FROM operation.tarjeta_almacen
                        WHERE ur='+%dG.dG.ur%+' AND id_periodo='+%dG.dG.id_periodo%+' 
                        AND articulo='+'\\''+@ifThenElse(%articulo%==null,'0',%articulo%)+'\\' ORDER BY id_tarjeta_almacen DESC limit 1','resultado','int','MAGNITUS')" columnas="3" />
                        <campo name="total" text="Total *" calcCliente="@ifThenElse(%existencia%==null,0,%existencia%)*@ifThenElse(%costo_unitario%==null,0,%costo_unitario%)" habilitado="false" columnas="3" />
                        <campo name="cantidad_salida" text="Cantidad Salida *" validacion="%cantidad_salida%==null" validacionMensaje="Indique Cantidad de Salida" columnas="3" />
                        <campo name="observaciones" text="Observaciones" columnas="3" margen-derecho="2"/>


                       <!--  <campo name="id_cat_cog" text="" llaveForanea="false" calc="4" visible="false" columna-visible="false"/>
                        <campo name="id_cog" text="COG" width="300" habilitado="false"
                        calcCliente="@consultaDirec('SELECT (id_cat_clasificacion_objeto_gasto) AS result FROM catalog.articulos WHERE ur='+%dG.dG.ur%+' AND '+'periodo='+'\\''+%dG.dG.id_periodo%+'\\''+' AND '+' clave_articulo='+'\\''+%articulo%+'\\'','result','string','MAGNITUS')"
                        validacion="%id_cog%==null" validacionMensaje="Favor de agregar el COG" columnas="3" margen-derecho="2" />
                        
                        <campo name="des_articulo" text="Descripción del artículo" width="200" referenciaForanea="articulo" celdaForanea="descripcion_articulo" autocompletar="true" columnas="3" margen-izquierdo="2" />
                        
                        <campo name="clave_cuentas_contables" text="Clave Cuenta C.A" width="300" descripcionForanea="clave_cuenta,descripcion" validacion="%clave_cuentas_contables%==null" validacionMensaje="Favor de seleccionar clave cuenta C.A" columnas="3" margen-derecho="2" />
                        
                        <campo name="des_cuenta_contable" text="Descripcion de Cuenta C.A" referenciaForanea="clave_cuentas_contables" celdaForanea="descripcion" autocompletar="true" width="300" validacion="%des_cuenta_contable%==null" validacionMensaje="Favor de agregar descripcion de cuenta C.A" columnas="3" margen-izquierdo="2" />
                        

                        
                        <campo name="des_unidad_medida" text="Descripción Unidad de Medida" width="230"  referenciaForanea="id_unidad_medida" celdaForanea="descripcion" autocompletar="true" columnas="3" margen-izquierdo="2" />
                        
                        
                        
                        <campo name="centro_registro" text="Clave Centro de Registro" validacion="%centro_registro%==null" validacionMensaje="Favor de agregar clave de centro registro" width="220" columnas="3" margen-izquierdo="2" />
                        
                        <campo name="des_centro_registro" text="Descripción Centro de Registro"  width="230" referenciaForanea="centro_registro" celdaForanea="descripcion" autocompletar="true" columnas="3" margen-derecho="2"/>
                        
                        
                        
                        <campo name="des_fondo_contable" text="Descripción de Fondo" width="200" referenciaForanea="fondo_contable"  celdaForanea="descripcion" autocompletar="true" columnas="3" margen-derecho="2" />
                        
                        
                        
                        
                        
                        <campo name="observaciones" text="Observaciones" width="720" height="150" validacion="%observaciones%==null" validacionMensaje="Favor de agregar observaciones" columnas="6" margen-izquierdo="2"/>    
                        
                        <campo name="id_cat_cog" text="" llaveForanea="false" calc="4" visible="false" columna-visible="false"/>
                        
                        <campo name="id_cat_fondo" text="" llaveForanea="false" calc="3" visible="false" columna-visible="false"/>
                        
                        <campo name="usuario_alta" text="usuario_alta" calc="%rEA.rEA.id_registro_act_almacen%" llaveForanea="false" visible="false"/> -->
                    </tabla>
                </detalles>
            </componente>
        </nivel>
        <nivel nombre="b_acumularS" id="b_acumularS" interactivo="false" ejecutar="%dG.dG.id_tipo_movimientos%==2">
            <componente tipo="cursor" nombre="b_acumularS" id="b_acumularS">
                <tabla schema="operation" nombre="registro_act_almacen_det">
                    <campo name="ur" filtroCampo="ur" filtroOperador="=" filtroValor="%rSA.rSA.ur%"/>
                    <campo name="id_periodo" filtroCampo="id_periodo" filtroOperador="=" filtroValor="%rSA.rSA.id_periodo%"/>
                    <campo name="id_registro_act_almacen" filtroCampo="id_registro_act_almacen" filtroOperador="=" filtroValor="%rSA.rSA.id_registro_act_almacen%"/>
                    <campo name="id_registro_act_almacen_det"/>
                    <campo name="total"/>
                    <campo name="articulo"/>
                    <campo name="acumulado" local="true" type="double" calc="$sumatoria.total$"/>
                </tabla>
            </componente>
        </nivel>
        <nivel nombre="acumular" id="acumularS" interactivo="false" ejecutar="%dG.dG.id_tipo_movimientos%==2">
            <componente tipo="cursor" nombre="acumular" id="acumularS">
                <tabla schema="operation" nombre="registro_act_almacen">
                    <campo name="ur" filtroCampo="ur" filtroOperador="=" filtroValor="%rSA.rSA.ur%"/>
                    <campo name="id_periodo" filtroCampo="id_periodo" filtroOperador="=" filtroValor="%rSA.rSA.id_periodo%"/>
                    <campo name="id_registro_act_almacen" filtroCampo="id_registro_act_almacen" filtroOperador="=" filtroValor="%rSA.rSA.id_registro_act_almacen%"/>
                    <campo name="total" calc="%b_acumularS.b_acumularS.acumulado%"/>
                </tabla>
            </componente>
        </nivel>
        <nivel nombre="crearNuevaInstancia" id="cISalida" interactivo="false" ejecutar="%dG.dG.id_tipo_movimientos%==2">
            <componente tipo="solicitud" nombre="EnvioParametrosDynamo" id="cISalida" >
                <parametros url="$config.request$" metodo="POST" accion="crearNuevaInstancia" tipo="json">
                    <parametro name="enterprise" calc="'MAGNITUS'"/>
                    <parametro name="process" calc="'d02bebb1-7f66-44d5-9d9b-f60edecaf402'"/>
                    <parametro name="user" calc="$protocolarios.user$"/>
                    <parametro name="out_ur" calc="%rSA.rSA.ur%" mostrarEsc="true"/>
                    <parametro name="out_id_periodo" calc="%rSA.rSA.id_periodo%" mostrarEsc="true"/>
                    <parametro name="out_id_tipo_movimientos" calc="%rSA.rSA.id_tipo_movimientos%" mostrarEsc="true"/>
                    <parametro name="out_id_registro_act_almacen" calc="%rSA.rSA.id_registro_act_almacen%" mostrarEsc="true"/>
                    <parametro name="out_tarjeta_almacen" calc="'1'" mostrarEsc="true"/>
                </parametros>
            </componente>
        </nivel>
        <nivel nombre="Consulta Salidas de Almacén" id="sAlida" mostrarNivelAnterior="false" mostrarProximoNivel="false" ejecutar="%dG.dG.id_tipo_movimientos%==2">
            <componente tipo="reporte" nombre="Consulta Salidas de Almacén" id="sAlida">
                <reporte nombre="repor_salAlmacen_jsus" update="true" nombreDocumento="'Consulta Salidas de Almacén'" expediente="Actualizaciones de Almacén"  grupo="%dG.dG.id_registro_act_almacen%" url="$config.repository_upload_file$">
                     <campo name="ur"  type="long" calc="%rSA.rSA.ur%"/>
                     <campo name="periodo" type="long" calc="%rSA.rSA.id_periodo%" />
                     <campo name="id_registro_act_almacen" type="long" calc="%rSA.rSA.id_registro_act_almacen%"/>
                     <campo name="usuario" type="string" calc="$protocolarios.user$"/>
                </reporte>
            </componente>
        </nivel>
        <nivel nombre="barrido_false" id="bFalse" ejecutar="%dG.dG.id_tipo_movimientos%==3" interactivo="false">
            <componente tipo="cursor" nombre="bFalse" id="bFalse">
                <tabla schema="operation" nombre="tarjeta_almacen">
                    <campo name="ur" text="" filtroCampo="ur" filtroOperador="=" filtroValor="%bPer.bPer.id_unidad_responsable%"/>
                    <campo name="id_periodo" text="" filtroCampo="id_periodo" filtroOperador="=" filtroValor="%bPer.bPer.id_periodo%"/>
                    <campo name="id_tarjeta_almacen"/>
                    <campo name="seleccion_tras_alm" calc="false"/>
                </tabla>
            </componente>
        </nivel>
        <nivel nombre="Registra Traspaso de Almacén" id="rTA" ejecutar="%dG.dG.id_tipo_movimientos%==3" mostrarNivelAnterior="false">
            <componente tipo="tabla" nombre="Registra Traspaso de Almacén" id="rTA" mostrarAgregar="false" mostrarEditar="false" mostrarEliminar="false">
                <tabla schema="operation" nombre="tarjeta_almacen">
                    <campo name="ur" text="" filtroCampo="ur" filtroOperador="=" filtroValor="%bPer.bPer.id_unidad_responsable%" visible="false" columna-visible="false"/>
                    <campo name="id_periodo" text="" filtroCampo="id_periodo" filtroOperador="=" filtroValor="%bPer.bPer.id_periodo%" visible="false" columna-visible="false"/>
                    <campo name="id_tarjeta_almacen" text="" visible="false" columna-visible="false"/>
                    <campo name="articulo" text="Clave artículo"  descripcionForaneaTabla="descripcion_articulo"/>
                    <!-- <campo name="" text="Descripción Específica"/> -->
                    <campo name="id_unidad_medida" text="Unidad de Medida" descripcionForaneaTabla="descripcion"/>
                    <campo name="id_almacen" text="Almacén"/>
                    <campo name="existencia" text="Existencia"/>
                    <campo name="cantidad_traspaso" text="Cantidad Traspaso" editable="true"/>
                    <campo name="costo_unitario" text="Costo Unitario" formatoMoneda="true"/>
                    <campo name="total" text="Costo Total" formatoMoneda="true"/>
                    <campo name="observaciones" text="Observaciones"/>
                    <campo name="seleccion_tras_alm" text="Selección" editable="true"/>
                </tabla>
            </componente>
        </nivel>
        <nivel nombre="btarjeta_almacen" id="bTA" ejecutar="%dG.dG.id_tipo_movimientos%==3" interactivo="false">
            <componente tipo="cursor" nombre="Registra Traspaso de Almacén" id="bTA">
                <tabla schema="operation" nombre="tarjeta_almacen">
                    <campo name="ur" text="" filtroCampo="ur" filtroOperador="=" filtroValor="%bPer.bPer.id_unidad_responsable%"/>
                    <campo name="id_periodo" text="" filtroCampo="id_periodo" filtroOperador="=" filtroValor="%bPer.bPer.id_periodo%"/>
                    <campo name="seleccion_tras_alm" filtroCampo="seleccion_tras_alm" filtroOperador="=" filtroValor="true"/>
                    <campo name="id_registro_act_almacen" calc="%dG.dG.id_registro_act_almacen%"/>
                    <campo name="id_tarjeta_almacen"/>
                    <campo name="existencia"/>
                </tabla>
            </componente>
        </nivel>
        <nivel nombre="Datos Generales del Traspaso" id="dGT" mostrarProximoNivel="false" mostrarNivelAnterior="false" ejecutar="%dG.dG.id_tipo_movimientos%==3">
            <componente tipo="formulario" nombre="Datos Generales del Traspaso" id="dGT" accionDefault="editar">
                <tabla schema="operation" nombre="tarjeta_almacen">
                    <campo name="ur" text="" calc="%bTA.bTA.ur%" llaveForanea="false" visible="false"/>
                    <campo name="id_periodo" text="" calc="%bTA.bTA.id_periodo%" llaveForanea="false" visible="false"/>
                    <campo name="id_tarjeta_almacen" text="" calc="%bTA.bTA.id_tarjeta_almacen%" llaveForanea="false" visible="false"/>
                    <campo name="folio_movimiento_traspaso" text="Folio" 
                    calc="@concatenar('ALM-'+@subCadena(@ifThenElse(
                    @consultaDirec('
                    SELECT (folio_movimiento_traspaso) AS resultado
                    FROM operation.tarjeta_almacen
                    WHERE ur='+%bTA.bTA.id_unidad_responsable%+' AND id_periodo='+%bTA.bTA.id_periodo%+' ORDER BY folio_movimiento DESC limit 1','resultado','string','MAGNITUS')==null
                    ,
                    '000001'
                    ,
                    @consultaDirec('
                    SELECT to_char((((substring(folio_movimiento_traspaso from char_length(folio_movimiento_traspaso)-4)::int)+1)),\\''+'00000'+'\\') as resultado
                    FROM operation.tarjeta_almacen
                    WHERE ur='+%bTA.bTA.id_unidad_responsable%+' AND id_periodo='+%bTA.bTA.id_periodo%+' ORDER BY folio_movimiento_traspaso DESC limit 1','resultado','int','MAGNITUS')
                    ),1,6))"
                    columnas="2" />
                    <campo name="id_almacen_destino" text="Almacen Destino" descripcionForanea="nombre" columnas="2" />
                    <campo name="fecha" text="Fecha" calc="@fechaSistema('YYYY-MM-dd HH:mm:ss')" columnas="2" />
                    <campo name="observaciones" text="Observaciones" columnas="2" />
                </tabla>
                <estilos>
                    <boton nombre="grabar" visible="true" texto="Guardar" columnas="2" margen-izquierdo="4"/>
                </estilos>
                <acciones>
                    <accion nombre="grabar" hacer="saltar siguiente nivel"/>
                </acciones>
            </componente>
        </nivel>
        <nivel nombre="crearNuevaInstancia" id="cITraspaso" interactivo="false" ejecutar="%dG.dG.id_tipo_movimientos%==3">
            <componente tipo="solicitud" nombre="EnvioParametrosDynamo" id="cITraspaso" >
                <parametros url="$config.request$" metodo="POST" accion="crearNuevaInstancia" tipo="json">
                    <parametro name="enterprise" calc="'MAGNITUS'"/>
                    <parametro name="process" calc="'d02bebb1-7f66-44d5-9d9b-f60edecaf402'"/>
                    <parametro name="user" calc="$protocolarios.user$"/>
                    <parametro name="out_ur" calc="%dG.dG.ur%" mostrarEsc="true"/>
                    <parametro name="out_id_periodo" calc="%dGT.dGT.id_periodo%" mostrarEsc="true"/>
                    <parametro name="out_id_tipo_movimientos" calc="%dG.dG.id_tipo_movimientos%" mostrarEsc="true"/>
                    <parametro name="out_id_registro_act_almacen" calc="%bTA.bTA.id_registro_act_almacen%" mostrarEsc="true"/>
                    <parametro name="out_tarjeta_almacen" calc="%bTA.bTA.id_tarjeta_almacen%" mostrarEsc="true"/>
                </parametros>
            </componente>
        </nivel>
        <nivel nombre="Consulta Traspasos de Almacén" id="tras" mostrarNivelAnterior="false" mostrarProximoNivel="false" ejecutar="%dG.dG.id_tipo_movimientos%==3">
            <componente tipo="reporte" nombre="Consulta Traspasos de Almacén" id="tras">
                <reporte nombre="Rep_Traspaso_AL" update="true" nombreDocumento="'Consulta Traspasos de Almacén'" expediente="Actualizaciones de Almacén"  grupo="%dG.dG.id_registro_act_almacen%" url="$config.repository_upload_file$">
                     <campo name="ur"  type="long" calc="%dG.dG.ur%"/>
                     <campo name="periodo" type="long" calc="%dGT.dGT.id_periodo%"/>
                     <campo name="id_tarjeta_almacen" type="long" calc="%bTA.bTA.id_tarjeta_almacen%"/>
                     <campo name="usuario" type="string" calc="$protocolarios.user$"/>
                </reporte>
            </componente>
        </nivel>
    </pagina>
</tarea>